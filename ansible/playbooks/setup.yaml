---
- name: Setup local dev environment (Docker, kind, kubectl, registry)
  hosts: local
  connection: local
  become: yes
  vars:
    registry_port: 10090
    kind_cluster_name: dev-cluster
  tasks:
    - name: Ensure apt cache is up to date
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - docker.io
          - git
          - python3-pip
        state: present

    - name: Add current user to docker group
      user:
        name: "{{ lookup('env','USER') }}"
        groups: docker
        append: yes

    - name: Install kubectl (if missing)
      become: yes
      shell: |
        if ! command -v kubectl >/dev/null 2>&1; then
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          rm kubectl
        fi
      args:
        executable: /bin/bash

    - name: Install kind (if missing)
      shell: |
        if ! command -v kind >/dev/null 2>&1; then
          curl -Lo ./kind "https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64"
          chmod +x ./kind
          mv ./kind /usr/local/bin/kind
        fi
      args:
        executable: /bin/bash

    - name: Start local docker registry
      community.docker.docker_container:
        name: registry-local
        image: registry:2
        state: started
        restart_policy: always
        published_ports:
          - "{{ registry_port }}:5000"

    - name: Create kind cluster (if not exists)
      shell: |
        if ! kind get clusters | grep -q "{{ kind_cluster_name }}"; then
          kind create cluster --name "{{ kind_cluster_name }}"
        fi
      args:
        executable: /bin/bash

    - name: Ensure kubectl can access the cluster
      shell: kubectl cluster-info
      args:
        executable: /bin/bash

